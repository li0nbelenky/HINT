#!/bin/bash

apt-get update
unattended-upgrades -v
sudo apt-get install npm python-pip -y
sudo pip install awscli
sudo ln -s /usr/bin/nodejs /usr/bin/node

## install nvm
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.6/install.sh | bash

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

## download keys ###
aws s3 cp s3://hint-infra/authorized_keys /home/ubuntu/.ssh/authorized_keys
aws s3 cp s3://hint-infra/start-services-master.sh /home/ubuntu/infra/start-services-master.sh
aws s3 cp s3://hint-infra/start-services-staging.sh /home/ubuntu/infra/start-services-staging.sh


### install Docker ###
while :; do
    wget -qO- https://get.docker.com/ | sh
    if ! which docker; then
        echo "failed downloading docker. retrying."
        sleep 5
        continue
    fi
    break
done

sudo curl -L https://github.com/docker/compose/releases/download/1.17.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

mkdir /home/ubuntu/infra
cd /home/ubuntu/infra
chmod +x start-services*

## Create HINT network ##
docker network create hintnet

docker login -u ironsrcci -p 6f3TqGoqmj
addgroup ubuntu docker
sudo usermod -a -G docker ubuntu

sudo su ubuntu -c /home/ubuntu/infra/start-services-staging.sh

## Start front
cd /home/ubuntu/infra
sudo su ubuntu -c /home/ubuntu/infra/app-start-staging.sh